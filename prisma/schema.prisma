// Prisma schema for University Platform
// Database: Supabase PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// USER & ROLE MANAGEMENT
// ============================================

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  emailVerified DateTime?
  name          String?
  image         String?
  role          UserRole  @default(STUDENT)
  
  // Auth relationships
  accounts      Account[]
  sessions      Session[]
  
  // Profile relationships
  studentProfile StudentProfile?
  teacherProfile TeacherProfile?
  clubProfile    ClubProfile?
  adminProfile   AdminProfile?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("users")
}

model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String?  @db.Text
  access_token       String?  @db.Text
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?  @db.Text
  session_state      String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

enum UserRole {
  STUDENT
  TEACHER
  CLUB
  ADMIN
  SUPER_ADMIN
}

model StudentProfile {
  id                    String   @id @default(uuid())
  userId                String   @unique
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  studentId             String   @unique
  major                 String?
  yearOfStudy           Int?
  interests             String[] // Array of interest tags
  
  // Scores
  readinessScore        Int      @default(0)
  citizenshipScore      Int      @default(0)
  selfManagementScore   Int      @default(0)
  
  // Score components tracking (JSON for detailed breakdown)
  readinessComponents   Json     @default("{}")
  citizenshipComponents Json     @default("{}")
  selfManagementComponents Json  @default("{}")
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@map("student_profiles")
}

model TeacherProfile {
  id          String   @id @default(uuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  employeeId  String   @unique
  department  String
  position    String?
  specialization String[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("teacher_profiles")
}

model ClubProfile {
  id          String   @id @default(uuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  clubName    String   @unique
  description String?
  category    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("club_profiles")
}

model AdminProfile {
  id          String   @id @default(uuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  employeeId  String   @unique
  department  String
  permissions String[] // Specific admin permissions
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("admin_profiles")
}

// ============================================
// SCORING SYSTEMS
// ============================================

// University Readiness Score Activities
model ReadinessActivity {
  id          String   @id @default(uuid())
  studentId   String
  type        ReadinessType
  description String
  points      Int
  metadata    Json?    // Additional data like course name, skill, etc.
  createdAt   DateTime @default(now())

  @@index([studentId, createdAt])
  @@map("readiness_activities")
}

enum ReadinessType {
  LEARNING_DISCIPLINE  // Tutorials, exam prep
  SKILL_GROWTH        // New skills validated
  ENGAGEMENT          // Meetings with teachers/admin
  CAREER_READINESS    // CV, mock interviews
  AUTONOMY            // Solo learning streaks
}

// Academic Citizenship Score Activities
model CitizenshipActivity {
  id          String   @id @default(uuid())
  studentId   String
  type        CitizenshipType
  description String
  points      Int
  verified    Boolean  @default(false)
  metadata    Json?
  createdAt   DateTime @default(now())

  @@index([studentId, createdAt])
  @@map("citizenship_activities")
}

enum CitizenshipType {
  SHARED_NOTES
  HELPED_PEER
  REPORTED_ISSUE
  GAVE_FEEDBACK
  QUALITY_CONTRIBUTION
}

// Self-Management Score Tracking
model SelfManagementEvent {
  id          String   @id @default(uuid())
  studentId   String
  type        SelfManagementType
  status      EventStatus
  points      Int
  metadata    Json?
  eventDate   DateTime
  createdAt   DateTime @default(now())

  @@index([studentId, eventDate])
  @@map("self_management_events")
}

enum SelfManagementType {
  APPOINTMENT
  DEADLINE
  ATTENDANCE
  ADMIN_INTERACTION
}

enum EventStatus {
  COMPLETED
  MISSED
  LATE
  ON_TIME
}

// Learning Streaks
model LearningStreak {
  id          String   @id @default(uuid())
  studentId   String   @unique
  currentStreak Int    @default(0)
  longestStreak Int    @default(0)
  lastActivityDate DateTime?
  
  @@map("learning_streaks")
}

// ============================================
// CAMPUS MAP & LOCATIONS
// ============================================

model Location {
  id          String       @id @default(uuid())
  name        String
  type        LocationType
  building    String
  floor       Int?
  roomNumber  String?
  description String?
  capacity    Int?
  
  // Coordinates for map
  latitude    Float
  longitude   Float
  
  // Features & amenities
  features    String[]
  equipment   String[]
  
  // Availability
  isAvailable Boolean      @default(true)
  
  // Ratings
  ratings     LocationRating[]
  
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([type, building])
  @@map("locations")
}

enum LocationType {
  CLASSROOM
  LAB
  LIBRARY
  OFFICE
  CAFETERIA
  SPORTS_FACILITY
  STUDY_ROOM
  AUDITORIUM
  OTHER
}

model LocationRating {
  id          String   @id @default(uuid())
  locationId  String
  location    Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  userId      String
  
  // Rating categories (1-5 scale)
  cleanliness    Int
  equipment      Int
  accessibility  Int
  quietness      Int?  // Optional for some locations
  
  comment     String?
  createdAt   DateTime @default(now())

  @@unique([locationId, userId])
  @@map("location_ratings")
}

// ============================================
// RECOMMENDATION SYSTEM
// ============================================

model Recommendation {
  id          String   @id @default(uuid())
  studentId   String
  type        RecommendationType
  title       String
  description String
  url         String?
  difficulty  String?  // Beginner, Intermediate, Advanced
  estimatedHours Int?
  tags        String[]
  
  // Matching score based on interests
  relevanceScore Float
  
  // Status tracking
  status      RecommendationStatus @default(PENDING)
  viewedAt    DateTime?
  completedAt DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([studentId, status, createdAt])
  @@map("recommendations")
}

enum RecommendationType {
  COURSE
  WORKSHOP
  TUTORIAL
  CAREER_RESOURCE
  SKILL_BUILDING
  CERTIFICATION
}

enum RecommendationStatus {
  PENDING
  VIEWED
  IN_PROGRESS
  COMPLETED
  DISMISSED
}

// Predefined courses/workshops in the system
model LearningResource {
  id          String   @id @default(uuid())
  title       String
  description String
  type        RecommendationType
  category    String
  tags        String[]
  url         String?
  difficulty  String
  estimatedHours Int
  provider    String?
  
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([type, category])
  @@map("learning_resources")
}

// ============================================
// NOTIFICATIONS SYSTEM
// ============================================

model Notification {
  id          String   @id @default(uuid())
  title       String
  message     String
  type        NotificationType
  priority    NotificationPriority @default(NORMAL)
  
  // Target audience
  targetRole  UserRole?  // If null, send to all
  targetUsers String[]   // Specific user IDs
  
  // Creator
  createdBy   String
  
  // Metadata
  link        String?
  metadata    Json?
  
  // Publishing
  publishedAt DateTime?
  expiresAt   DateTime?
  
  // Read tracking
  readBy      String[]   @default([])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([targetRole, publishedAt])
  @@index([createdAt])
  @@map("notifications")
}

enum NotificationType {
  ADMIN_ANNOUNCEMENT
  CLUB_EVENT
  SYSTEM_UPDATE
  ACHIEVEMENT
  DEADLINE_REMINDER
  RECOMMENDATION
  GENERAL
}

enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}
